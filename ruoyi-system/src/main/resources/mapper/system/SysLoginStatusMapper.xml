<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.SysLoginStatusMapper">
    
    <resultMap type="com.ruoyi.system.domain.SysLoginStatus" id="SysLoginStatusResult">
        <result property="id"    column="id"    />
        <result property="orgId"    column="org_id"    />
        <result property="orgName"    column="org_name"    />
        <result property="loginName"    column="login_name"    />
        <result property="userName"    column="user_name"    />
        <result property="startTime"    column="start_time"    />
        <result property="endTime"    column="end_time"    />
        <result property="onlineLen"    column="online_len"    />
        <result property="status"    column="status"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="censusDate"    column="censusDate"    />
        <result property="loginNum"    column="loginNum"    />
        <result property="sque"    column="sque"    />
    </resultMap>

    <sql id="selectSysLoginStatusVo">
        select id, org_id, org_name, login_name, user_name, start_time, end_time, online_len, status, create_by, create_time, update_by, update_time from sys_login_status
    </sql>

    <select id="selectSysLoginStatusList" parameterType="SysLoginStatus" resultMap="SysLoginStatusResult">
        SELECT (@a :=@a + 1)as sque,t.censusDate,t.login_name,t.user_name,t.org_name,t.start_time,t.end_time,t.loginNum,t.online_len,t.status
        from(
            select
                DATE_FORMAT(create_time,'%Y-%m-%d')as censusDate,
                login_name,
                max(user_name) as user_name,
                max(org_name) as org_name,
                min(start_time) as start_time,
                max(end_time) as end_time,
                count(1) as loginNum,
                sum(CONVERT(online_len,DECIMAL(20,2))) as online_len,
                max(status) as status
            from sys_login_status
            WHERE org_id = #{orgId}
            group by DATE_FORMAT(create_time,'%Y-%m-%d'),login_name
            ORDER BY censusDate desc
        )t,(SELECT @a := 0) t1
        where 1=1
        <if test="userName != null and userName != ''">
            AND t.user_name like concat('%', #{userName}, '%')
        </if>
        <if test="status != null and status != ''">
            AND t.status = #{status}
        </if>
        <if test="startCensusDate != null">
            AND t.censusDate <![CDATA[>=]]> DATE_FORMAT(#{startCensusDate},'%Y-%m-%d')
        </if>
        <if test="endCensusDate != null">
            AND t.censusDate <![CDATA[<=]]> DATE_FORMAT(#{endCensusDate},'%Y-%m-%d')
        </if>
    </select>
    
    <select id="selectSysLoginStatusById" parameterType="String" resultMap="SysLoginStatusResult">
        <include refid="selectSysLoginStatusVo"/>
        where id = #{id}
    </select>
        
    <insert id="insertSysLoginStatus" parameterType="SysLoginStatus" useGeneratedKeys="true" keyProperty="id">
        insert into sys_login_status
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null  and id != ''">id,</if>
            <if test="orgId != null  and orgId != ''">org_id,</if>
            <if test="orgName != null  and orgName != ''">org_name,</if>
            <if test="loginName != null  and loginName != ''">login_name,</if>
            <if test="userName != null  and userName != ''">user_name,</if>
            <if test="startTime != null ">start_time,</if>
            <if test="endTime != null ">end_time,</if>
            <if test="onlineLen != null  and onlineLen != ''">online_len,</if>
            <if test="status != null  and status != ''">status,</if>
            <if test="createBy != null  and createBy != ''">create_by,</if>
            <if test="createTime != null ">create_time,</if>
            <if test="updateBy != null  and updateBy != ''">update_by,</if>
            <if test="updateTime != null ">update_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null  and id != ''">#{id},</if>
            <if test="orgId != null  and orgId != ''">#{orgId},</if>
            <if test="orgName != null  and orgName != ''">#{orgName},</if>
            <if test="loginName != null  and loginName != ''">#{loginName},</if>
            <if test="userName != null  and userName != ''">#{userName},</if>
            <if test="startTime != null ">#{startTime},</if>
            <if test="endTime != null ">#{endTime},</if>
            <if test="onlineLen != null  and onlineLen != ''">#{onlineLen},</if>
            <if test="status != null  and status != ''">#{status},</if>
            <if test="createBy != null  and createBy != ''">#{createBy},</if>
            <if test="createTime != null ">#{createTime},</if>
            <if test="updateBy != null  and updateBy != ''">#{updateBy},</if>
            <if test="updateTime != null ">#{updateTime},</if>
         </trim>
    </insert>

    <update id="updateSysLoginStatus" parameterType="SysLoginStatus">
        update sys_login_status
        <trim prefix="SET" suffixOverrides=",">
            <if test="endTime != null ">end_time = #{endTime},</if>
            <if test="onlineLen != null  and onlineLen != ''">online_len = #{onlineLen},</if>
            <if test="status != null  and status != ''">status = #{status},</if>
            <if test="updateBy != null  and updateBy != ''">update_by = #{updateBy},</if>
            <if test="updateTime != null ">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>


    
</mapper>